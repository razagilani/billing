<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title></title>

	<script type="text/javascript" src="jquery-1.4.2.js"></script>
	<script type="text/javascript">
	//<![CDATA[

		var httpObject = null;
		var xmlDoc = null;
		var appAvailable = false;

		$(document).ready(function()
		{
			// using low level API since high level API does not support PUT
			jQuery.ajax({
				url: "http://skyline/exist/rest/Test10001/Skyline-1-10001.xml", //  http://skyline/exist/rest/db/test/test.xml http://skyline/exist/rest/db/10001/Skyline-1-10001.xml
				type: "GET",
				processData: false,
				data: xmlDoc,
				dataType: "xml",
				success: handleXML_GET,
				error: handleXML_GET_error
			});
		})

		function handleXML_GET(data)
		{

			xmlDoc = data;
			bindXML();

		}

		function handleXML_GET_error(xhr, status, error)
		{
			// ToDo: put into document body
			alert(status);
			alert("readyState: "+xhr.readyState+"\nstatus: "+xhr.status);
			alert("responseText: "+xhr.responseText);
		}

		function handleXML_PUT(data, status, req)
		{
			// never make it here due to a bug(?) in JQuery and the way its xmlparser handles server return values
			alert("PUT " + data);
		}

		function handleXML_PUT_error(xhr, status, error)
		{
			if (status == "parsererror")
			{
				// http://james.revillini.com/2006/10/27/no-element-found-in-firebug-or-firefox-javascript-console/
				// probably need to determine how to check that PUT completed successfully (which if it does, the server return data still causes a failure in jquery)
				alert(status);
			} else {
				alert(status);
				alert("readyState: "+xhr.readyState+"\nstatus: "+xhr.status);
				alert("responseText: "+xhr.responseText);
			}
		}


		// given xml, bind it to the form
		function bindXML()
		{

			// remove previously created form
			$("#xmlForm").empty();

			$("#xmlForm").append("<input type=\"submit\" action=\"submit\"></input>");

			var chargegroup = xmlDoc.getElementsByTagName("ub:chargegroup");

			for (cg = 0; cg < chargegroup.length; cg++)
			{
				var charges = chargegroup[cg].getElementsByTagName("ub:charges");
				if (charges[0].attributes[0].nodeValue == "actual")
				{

					$("#xmlForm").append("<fieldset id=\"fieldset"+cg+"\">");
					$("#fieldset"+cg).append("<legend>Chargegroup "+cg+"</legend>");

					var charge = charges[0].getElementsByTagName("ub:charge");
					for(i = 0; i < charge.length; i++)
					{
						var description = charge[i].getElementsByTagName("ub:description")
						var descriptionText = (description.length == 1 && description[0].hasChildNodes()) ? description[0].childNodes[0].nodeValue : "";

						var quantity = charge[i].getElementsByTagName("ub:quantity")
						var quantityText = (quantity.length == 1 && quantity[0].hasChildNodes()) ? quantity[0].childNodes[0].nodeValue : "";
						var quantityUnits = (quantity.length == 1 && quantity[0].hasAttribute("units")) ? quantity[0].getAttribute("units") : "";

/*if (quantity.length == 1 && quantity[0].hasAttribute("units"))
{
	var attrs = quantity[0].attributes;
	alert ("Got attrs " + attrs);
	var unitEl = attrs[0];

	var path = getElementXPath(unitEl);
}*/

						var rate = charge[i].getElementsByTagName("ub:rate");
						var rateText = (rate.length == 1 && rate[0].hasChildNodes()) ? rate[0].childNodes[0].nodeValue : "";

						var total = charge[i].getElementsByTagName("ub:total");
						var totalText = (total.length == 1 && total[0].hasChildNodes()) ? total[0].childNodes[0].nodeValue : "";

						$("#fieldset"+cg).append("<a href=\"javascript:insertChargeAbove('"+getElementXPath(charge[i])+"'); \">Insert Above</a>&nbsp;");
						$("#fieldset"+cg).append("<a href=\"javascript:deleteCharge('"+getElementXPath(charge[i])+"');\">Delete</a>&nbsp;");
						$("#fieldset"+cg).append("<a href=\"javascript:insertChargeBelow('"+getElementXPath(charge[i])+"');\">Insert Below</a>");

						$("#fieldset"+cg).append("<input type=\"textfield\" id=\"cg"+cg+"-"+i+"\" name=\"" + getElementXPath(description[0]) + "\" value=\"" + descriptionText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
						$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(quantity[0]) + "\" id=\"cg"+cg+"-"+i+"\" value=\"" + quantityText +  "\" onChange=\"javascript:storeData(this.name, this.value);\">");
						$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(quantity[0]) + "/@units\" id=\"cg"+cg+"-"+i+"\" value=\"" + quantityUnits +  "\" onChange=\"javascript:storeData(this.name, this.value);\">");


						$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(rate[0]) + "\" id=\"cg"+cg+"-"+i+"\" value=\"" + rateText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
						$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(total[0]) + "\" id=\"cg"+cg+"-"+i+"\" value=\"" + totalText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
						$("#fieldset"+cg).append("<br/>");
					}
				}
			}
		}

		function submitXML(form)
		{
			jQuery.ajax({
				url: "http://skyline/exist/rest/Test10001/Skyline-1-10001.xml",
				type: "PUT",
				processData: false,
				contentType: "text/xml",
				data: xmlDoc,
				success: handleXML_PUT,
				error: handleXML_PUT_error
			});

		}


		function storeData(xpath, value)
		{
			//alert(xpath + " " + value);

try
{
 			var node = evaluateXPath(xmlDoc, xpath);
 } catch (e) {
 alert (e);
 }
 			//alert ("node is "+ node[0].childNodes[0].nodeValue);

STOPPED HERE - FIND OUT WHY THIS IS NOT SETTING ATTRIBUTE VALUE HERE

			node[0].childNodes[0].nodeValue = value;

		}

		function insertChargeAbove(xpath)
		{

 			var node = evaluateXPath(xmlDoc, xpath);
			// check to ensure path pointed to a node

			var charge = makeChargeGrove();

			node[0].parentNode.insertBefore(charge, node[0]);

			bindXML();

		}

		function insertChargeBelow(xpath)
		{

 			var node = evaluateXPath(xmlDoc, xpath);
			// check to ensure path pointed to a node

			var charge = makeChargeGrove();

			node[0].parentNode.insertBefore(charge, node[0].nextSibling);

			bindXML();

		}

		function deleteCharge(xpath)
		{

 			var node = evaluateXPath(xmlDoc, xpath);
			// check to ensure path pointed to a node

			node[0].parentNode.removeChild(node[0]);

			bindXML();

		}





		function makeChargeGrove()
		{
			var charge = xmlDoc.createElementNS("utilitybill","ub:charge");
			var chargeDescription = xmlDoc.createElementNS("utilitybill", "ub:description")
			chargeDescription.appendChild(xmlDoc.createTextNode("Enter description"));
			charge.appendChild(chargeDescription);

			var chargeQuantity = xmlDoc.createElementNS("utilitybill", "ub:quantity");
			chargeQuantity.appendChild(xmlDoc.createTextNode("Quantity"));
			charge.appendChild(chargeQuantity);

			var chargeRate = xmlDoc.createElementNS("utilitybill", "ub:rate");
			chargeRate.appendChild(xmlDoc.createTextNode("Rate"));
			charge.appendChild(chargeRate);

			var chargeTotal = xmlDoc.createElementNS("utilitybill", "ub:total");
			chargeTotal.appendChild(xmlDoc.createTextNode("Enter description"));
			charge.appendChild(chargeTotal);

			return charge;
		}


function getElementXPath(elt)
{
	var path = "";
	for (; elt && elt.nodeType == 1; elt = elt.parentNode)
	{
		idx = getElementIdx(elt);
		xname = elt.tagName;
		// all nodes must be indexed otherwise path node matches all
		// ToDo:  terminal node does not need an index
		if (idx > 0) xname += "[" + idx + "]";
		path = "/" + xname + path;
	}

	return path;
}

function getElementIdx(elt)
{
	var count = 1;
	for (var sib = elt.previousSibling; sib ; sib = sib.previousSibling)
	{
		if(sib.nodeType == 1 && sib.tagName == elt.tagName)	count++
	}

	return count;
}


function evaluateXPath(aNode, aExpr)
{
	var xpe = new XPathEvaluator();
	var nsResolver = xpe.createNSResolver(aNode.ownerDocument == null ? aNode.documentElement : aNode.ownerDocument.documentElement);
	var result = xpe.evaluate(aExpr, aNode, nsResolver, 0, null);
	var found = [];
	var res;
	while (res = result.iterateNext())
		found.push(res);
	return found;
}




	//]]>
	</script>
</head>
<body>



<p>Form</p>
<form id="xmlForm" action="javascript:submitXML(this);">
</form>
<p>Form</p>


<p>Values</p>
<p id="values"></p>
<p>Values</p>


</body>
</html>