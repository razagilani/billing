<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title></title>

	<script type="text/javascript" src="jquery-1.4.2.js"></script>
	<script type="text/javascript" src="jquery-jtemplates_0.7.8.js"></script>

	<script type="text/javascript">
	//<![CDATA[

		var httpObject = null;
		var xmlDoc = null;
		var appAvailable = false;

		$(document).ready(function()
		{
			// using low level API since high level API does not support PUT
			jQuery.ajax({
				url: "http://skyline/exist/rest/Test10001/Skyline-1-10001.xml", //  http://skyline/exist/rest/db/test/test.xml http://skyline/exist/rest/db/10001/Skyline-1-10001.xml
				type: "GET",
				processData: false,
				data: xmlDoc,
				dataType: "xml",
				success: handleXML_GET,
				error: handleXML_GET_error
			});
		})

		function handleXML_GET(data)
		{

			xmlDoc = data;
			bindXML();

		}

		function handleXML_GET_error(xhr, status, error)
		{
			// ToDo: put into document body
			alert(status);
			alert("readyState: "+xhr.readyState+"\nstatus: "+xhr.status);
			alert("responseText: "+xhr.responseText);
		}

		function handleXML_PUT(data, status, req)
		{
			// never make it here due to a bug(?) in JQuery and the way its xmlparser handles server return values
			alert("PUT " + data);
		}

		function handleXML_PUT_error(xhr, status, error)
		{
			if (status == "parsererror")
			{
				// http://james.revillini.com/2006/10/27/no-element-found-in-firebug-or-firefox-javascript-console/
				// probably need to determine how to check that PUT completed successfully (which if it does, the server return data still causes a failure in jquery)
				alert(status);
			} else {
				alert(status);
				alert("readyState: "+xhr.readyState+"\nstatus: "+xhr.status);
				alert("responseText: "+xhr.responseText);
			}
		}


		// given xml, bind it to the form
		function bindXML()
		{

			// remove previously created form
			$("#xmlForm").empty();

			$("#xmlForm").append("<input type=\"submit\" action=\"submit\"></input>");

			var chargegroup = xmlDoc.getElementsByTagName("ub:chargegroup");

			for (cg = 0; cg < chargegroup.length; cg++)
			{
				var charges = chargegroup[cg].getElementsByTagName("ub:charges")[0];
				if (charges.attributes[0].nodeValue == "actual")
				{

					$("#xmlForm").append("<fieldset id=\"fieldset"+cg+"\">");
					$("#fieldset"+cg).append("<legend>Chargegroup "+cg+"</legend>");

					var charge = charges.getElementsByTagName("ub:charge");
					for(i = 0; i < charge.length; i++)
					{
						$("#fieldset"+cg).append("<a href=\"javascript:insertChargeAbove('"+getElementXPath(charge[i])+"'); \">Insert Above</a>&nbsp;");
						$("#fieldset"+cg).append("<a href=\"javascript:deleteCharge('"+getElementXPath(charge[i])+"');\">Delete</a>&nbsp;");
						$("#fieldset"+cg).append("<a href=\"javascript:insertChargeBelow('"+getElementXPath(charge[i])+"');\">Insert Below</a>");

						var description = (charge[i].getElementsByTagName("ub:description"))[0];
						if (description)
						{
							var descriptionText = description.childNodes[0].nodeValue;
							$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(description) + "\" value=\"" + descriptionText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
						}

						var quantityElem = (charge[i].getElementsByTagName("ub:quantity"))[0];
						if (quantityElem)
						{
							var quantityText = quantityElem.childNodes[0].nodeValue;
							var quantityUnitsAttr = quantityElem.attributes["units"];
							var quantityUnitsText = quantityElem.getAttribute("units");

							$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(quantityElem) + "\" value=\"" + quantityText +  "\" onChange=\"javascript:storeData(this.name, this.value);\">");

							// handle quantity units attribute
							var opts = ["none", "kWh","Therms", "cents", "dollars", "KWD"];	// ToDo: pull from db
							$("#fieldset"+cg).append("<select id=\"select-1-"+cg+"-"+i+"\" name=\"" + getElementXPath(quantityUnitsAttr) + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
							opts.forEach(
								function(opt)
								{
									$("#select-1-"+cg+"-"+i).append("<option "+((quantityUnitsText == opt)?"selected":"")+">"+opt+"</option>");
								}
							);
						} else {
							// print link to add quantity Element
							$("#fieldset"+cg).append("<a href=\"javascript:insertQuantity('"+getElementXPath(charge[i])+"');\">Add Quantity</a>");
						}


						var rateElem = (charge[i].getElementsByTagName("ub:rate"))[0];
						if (rateElem)
						{
							var rateText = rateElem.childNodes[0].nodeValue;
							var rateUnitsAttr = rateElem.attributes["units"];
							var rateUnitsText = rateElem.getAttribute("units");

							$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(rateElem) + "\" value=\"" + rateText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");

							// handle quantity units attribute
							var opts = ["none", "dollars", "cents", "percentage"];	// ToDo: pull from db
							$("#fieldset"+cg).append("<select id=\"select-2-"+cg+"-"+i+"\" name=\"" + getElementXPath(rateUnitsAttr) + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
							opts.forEach(
								function(opt)
								{
									$("#select-2-"+cg+"-"+i).append("<option "+((rateUnitsText == opt)?"selected":"")+">"+opt+"</option>");
								}
							);
						} else {
							$("#fieldset"+cg).append("<a href=\"javascript:insertRate('"+getElementXPath(charge[i])+"');\">Add rate</a>");
						}

						var totalElem = (charge[i].getElementsByTagName("ub:total"))[0];
						if (totalElem)
						{
							var totalText = totalElem.childNodes[0].nodeValue;
							$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(totalElem) + "\" value=\"" + totalText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
						} else {
							// print link to add quantity Element
						}

						// all preceding charges plus this charge
						var runningChargesXPath = getElementXPath(charge[i]) + "/preceding-sibling::*/ub:total | " + getElementXPath(charge[i]) + "/ub:total";
						var runningChargesTotal = evaluateXPath(xmlDoc, "round(sum("+runningChargesXPath+")*100) div 100");

						$("#fieldset"+cg).append("<span>" + runningChargesTotal + "</span>");

						$("#fieldset"+cg).append("<br/>");

					}


					var chargesTotalElem = evaluateXPath(xmlDoc, getElementXPath(charges)+"/ub:total")[0];

					if (chargesTotalElem)
					{
						var chargesTotalText = chargesTotalElem.childNodes[0].nodeValue;
						$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(chargesTotalElem) + "\" value=\"" + chargesTotalText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
					}


					// bind to charge totals and show subtotal
					var chargesXPath = getElementXPath(charges) + "/ub:charge/ub:total";
					var subtotal = evaluateXPath(xmlDoc, "round(sum("+chargesXPath+")*100) div 100");
					$("#fieldset"+cg).append("<p>"+subtotal+"</p>");
				}
			}

		}



		function bindXML()
		{

			// remove previously created form
			$("#newXmlForm").empty();

			// copy template table into form for population
			$("#newXmlForm").append($("#formDetails-template").clone().attr("id", "formDetails"));

			//$("#newXmlForm").append("<input type=\"submit\" action=\"submit\"></input>");


			var chargegroup = xmlDoc.getElementsByTagName("ub:chargegroup");

			for (cg = 0; cg < chargegroup.length; cg++)
			{
				var formChargegroup = $("#formChargegroup-template").clone().attr("id", "formChargegroup-"+cg);
				$("#formDetails").append(formChargegroup);

				var charges = chargegroup[cg].getElementsByTagName("ub:charges")[0];
				if (charges.attributes[0].nodeValue == "actual")
				{

					var charge = charges.getElementsByTagName("ub:charge");
					for(i = 0; i < charge.length; i++)
					{

						var formCharge = $("#formCharge-template").clone().attr("id", "formCharge-"+cg+"-"+i);
						$("#formChargegroup-"+cg).append(formCharge);

						var chargeFields = $("#formCharge-"+cg+"-"+i+" td");

						chargeFields.slice(0,1).append("<a href=\"javascript:insertChargeAbove('"+getElementXPath(charge[i])+"'); \">Insert Above</a>&nbsp;");
						chargeFields.slice(1,2).append("<a href=\"javascript:deleteCharge('"+getElementXPath(charge[i])+"');\">Delete</a>&nbsp;");
						chargeFields.slice(2,3).append("<a href=\"javascript:insertChargeBelow('"+getElementXPath(charge[i])+"');\">Insert Below</a>");

						var description = (charge[i].getElementsByTagName("ub:description"))[0];
						if (description)
						{
							var descriptionText = description.childNodes[0].nodeValue;
							chargeFields.slice(3,4).append("<input type=\"textfield\" name=\"" + getElementXPath(description) + "\" value=\"" + descriptionText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
						}

						var quantityElem = (charge[i].getElementsByTagName("ub:quantity"))[0];
						if (quantityElem)
						{
							var quantityText = quantityElem.childNodes[0].nodeValue;
							var quantityUnitsAttr = quantityElem.attributes["units"];
							var quantityUnitsText = quantityElem.getAttribute("units");

							chargeFields.slice(4,5).append("<input type=\"textfield\" name=\"" + getElementXPath(quantityElem) + "\" value=\"" + quantityText +  "\" onChange=\"javascript:storeData(this.name, this.value);\">");

							// handle quantity units attribute
							var opts = ["none", "kWh","Therms", "cents", "dollars", "KWD"];	// ToDo: pull from db
							chargeFields.slice(5,6).append("<select id=\"select-1-"+cg+"-"+i+"\" name=\"" + getElementXPath(quantityUnitsAttr) + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
							opts.forEach(
								function(opt)
								{
									$("#select-1-"+cg+"-"+i).append("<option "+((quantityUnitsText == opt)?"selected":"")+">"+opt+"</option>");
								}
							);
						} else {
							// print link to add quantity Element
							chargeFields.slice(4,5).append("<a href=\"javascript:insertQuantity('"+getElementXPath(charge[i])+"');\">Add Quantity</a>");
						}


						var rateElem = (charge[i].getElementsByTagName("ub:rate"))[0];
						if (rateElem)
						{
							var rateText = rateElem.childNodes[0].nodeValue;
							var rateUnitsAttr = rateElem.attributes["units"];
							var rateUnitsText = rateElem.getAttribute("units");

							chargeFields.slice(6,7).append("<input type=\"textfield\" name=\"" + getElementXPath(rateElem) + "\" value=\"" + rateText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");

							// handle quantity units attribute
							var opts = ["none", "dollars", "cents", "percentage"];	// ToDo: pull from db
							chargeFields.slice(7,8).append("<select id=\"select-2-"+cg+"-"+i+"\" name=\"" + getElementXPath(rateUnitsAttr) + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
							opts.forEach(
								function(opt)
								{
									$("#select-2-"+cg+"-"+i).append("<option "+((rateUnitsText == opt)?"selected":"")+">"+opt+"</option>");
								}
							);
						} else {
							chargeFields.slice(6,7).append("<a href=\"javascript:insertRate('"+getElementXPath(charge[i])+"');\">Add rate</a>");
						}

						var totalElem = (charge[i].getElementsByTagName("ub:total"))[0];
						if (totalElem)
						{
							var totalText = totalElem.childNodes[0].nodeValue;
							chargeFields.slice(8,9).append("<input type=\"textfield\" name=\"" + getElementXPath(totalElem) + "\" value=\"" + totalText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
						} else {
							// print link to add quantity Element
						}

						// all preceding charges plus this charge
						var runningChargesXPath = getElementXPath(charge[i]) + "/preceding-sibling::*/ub:total | " + getElementXPath(charge[i]) + "/ub:total";
						var runningChargesTotal = evaluateXPath(xmlDoc, "round(sum("+runningChargesXPath+")*100) div 100");

						$("#fieldset"+cg).append("<span>" + runningChargesTotal + "</span>");

						$("#fieldset"+cg).append("<br/>");

					}


					var chargesTotalElem = evaluateXPath(xmlDoc, getElementXPath(charges)+"/ub:total")[0];

					if (chargesTotalElem)
					{
						var chargesTotalText = chargesTotalElem.childNodes[0].nodeValue;
						$("#fieldset"+cg).append("<input type=\"textfield\" name=\"" + getElementXPath(chargesTotalElem) + "\" value=\"" + chargesTotalText + "\" onChange=\"javascript:storeData(this.name, this.value);\">");
					}


					// bind to charge totals and show subtotal
					var chargesXPath = getElementXPath(charges) + "/ub:charge/ub:total";
					var subtotal = evaluateXPath(xmlDoc, "round(sum("+chargesXPath+")*100) div 100");
					$("#fieldset"+cg).append("<p>"+subtotal+"</p>");
				}
			}
		}



		function insertQuantity(xpath)
		{
			var node = evaluateXPath(xmlDoc, xpath);
			// find the sibling quantity gets inserted before
			var quantity = xmlDoc.createElementNS("utilitybill","ub:quantity");
			quantity.appendChild(xmlDoc.createTextNode("0"));

			var units = xmlDoc.createAttribute("units");

			quantity.setAttributeNode(units);
			var rateSibling = evaluateXPath(xmlDoc, xpath+"/ub:rate");
			if (rateSibling.length == 1)
			{
				rateSibling[0].parentNode.insertBefore(quantity, rateSibling[0]);
				bindXML();
				return;
			}
			var totalSibling = evaluateXPath(xmlDoc, xpath+"/ub:total");
			if (totalSibling.length == 1)
			{
				totalSibling[0].parentNode.insertBefore(quantity, totalSibling[0]);
				bindXML();
				return;
			}
		}

		function insertRate(xpath)
		{
			var node = evaluateXPath(xmlDoc, xpath);

			// find the sibling quantity gets inserted before
			var rate = xmlDoc.createElementNS("utilitybill","ub:rate");
			rate.appendChild(xmlDoc.createTextNode("0"));

			var units = xmlDoc.createAttribute("units");

			rate.setAttributeNode(units);
			var totalSibling = evaluateXPath(xmlDoc, xpath+"/ub:total");
			if (totalSibling.length == 1)
			{
				totalSibling[0].parentNode.insertBefore(rate, totalSibling[0]);
				bindXML();
				return;
			}
		}


		function insertChargeAbove(xpath)
		{

 			var node = evaluateXPath(xmlDoc, xpath);
			// check to ensure path pointed to a node

			var charge = makeChargeGrove();

			node[0].parentNode.insertBefore(charge, node[0]);

			bindXML();

		}

		function insertChargeBelow(xpath)
		{

 			var node = evaluateXPath(xmlDoc, xpath);
			// check to ensure path pointed to a node

			var charge = makeChargeGrove();

			node[0].parentNode.insertBefore(charge, node[0].nextSibling);

			bindXML();

		}

		function makeChargeGrove()
		{
			var charge = xmlDoc.createElementNS("utilitybill","ub:charge");
			var chargeDescription = xmlDoc.createElementNS("utilitybill", "ub:description")
			chargeDescription.appendChild(xmlDoc.createTextNode("Enter description"));
			charge.appendChild(chargeDescription);

			//var chargeQuantity = xmlDoc.createElementNS("utilitybill", "ub:quantity");
			//chargeQuantity.appendChild(xmlDoc.createTextNode("Quantity"));
			//charge.appendChild(chargeQuantity);

			//var chargeRate = xmlDoc.createElementNS("utilitybill", "ub:rate");
			//chargeRate.appendChild(xmlDoc.createTextNode("Rate"));
			//charge.appendChild(chargeRate);

			var chargeTotal = xmlDoc.createElementNS("utilitybill", "ub:total");
			chargeTotal.appendChild(xmlDoc.createTextNode("0.0"));
			charge.appendChild(chargeTotal);

			return charge;
		}

		function deleteCharge(xpath)
		{

 			var node = evaluateXPath(xmlDoc, xpath);
			// check to ensure path pointed to a node

			node[0].parentNode.removeChild(node[0]);

			bindXML();

		}


		function submitXML(form)
		{
			jQuery.ajax({
				url: "http://skyline/exist/rest/Test10001/Skyline-1-10001.xml",
				type: "PUT",
				processData: false,
				contentType: "text/xml",
				data: xmlDoc,
				success: handleXML_PUT,
				error: handleXML_PUT_error
			});

		}


		function storeData(xpath, value)
		{


			var node = evaluateXPath(xmlDoc, xpath);

 			if (node[0].nodeType == 1) // element
 			{
				node[0].childNodes[0].nodeValue = value;
 			} else if (node[0].nodeType == 2) { // attribute

 				var parent = node[0].ownerElement;
 				parent.setAttribute(node[0].nodeName, value);
 			}

 			bindXML();
 		}





// return xpath for a given node
function getElementXPath(node)
{
	if (node == null) return null;

	var path = "";

	if (node.nodeType == 2) // an atribute node was passed in
	{
		path = "/@" + node.nodeName;
		node = node.ownerElement;
	}

	for (; node && node.nodeType == 1; node = node.parentNode)
	{
		idx = getElementIdx(node);
		xname = node.tagName;
		// all nodes must be indexed otherwise path node matches all
		// ToDo:  terminal node does not need an index?
		if (idx > 0) xname += "[" + idx + "]";
		path = "/" + xname + path;
	}

	return path;
}

function getElementIdx(elt)
{
	var count = 1;
	for (var sib = elt.previousSibling; sib ; sib = sib.previousSibling)
	{
		if(sib.nodeType == 1 && sib.tagName == elt.tagName)	count++
	}

	return count;
}


function evaluateXPath(aNode, aExpr)
{
	var xpe = new XPathEvaluator();
	var nsResolver = xpe.createNSResolver(aNode.ownerDocument == null ? aNode.documentElement : aNode.ownerDocument.documentElement);
	var result = xpe.evaluate(aExpr, aNode, nsResolver, 0, null);
	var found = [];
	var res;

	switch(result.resultType)
	{
	case XPathResult.NUMBER_TYPE:
		return result.numberValue;
		break;
	// ToDo add other result types as we need to
	default:
		try
		{
			while (res = result.iterateNext())
				found.push(res);
		} catch (e) {
			alert(e);
		}
		return found;
	}

}

// xpath must be unambiguous and math only one node
function evaluateFullyQualifiedXPath(xpath)
{
	var nsResolver = xmlDoc.createNSResolver( xmlDoc.ownerDocument == null ? xmlDoc.documentElement : xmlDoc.ownerDocument.documentElement);
	var result = xmlDoc.evaluate(xpath, xmlDoc, nsResolver, XPathResult.FIRST_ORDERED_NODE_TYPE, null );
	return result;
}



	//]]>
	</script>
</head>
<body>


	<form id="xmlForm" action="javascript:submitXML(this);">
	</form>

	<div style="display: none;">
		<!-- template for newXmlForm -->
		<table id="formDetails-template" border="1">
			<thead>
				<tr>
					<th>Insert Above</th>
					<th>Delete</th>
					<th>Insert Below</th>
					<th>Description</th>
					<th>Quantity</th>
					<th>Units</th>
					<th>Rate</th>
					<th>Units</th>
					<th>Sum</th>
				</tr>
			</thead>
			<tfoot>
			</tfoot>
			<tbody id="formChargegroup-template">
				<tr id="formCharge-template">
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</tbody>
		</table>
	</div>

	<form id="newXmlForm" action="javascript:submitXML(this);">
	</form>

</body>
</html>