

Older, original doc for configuring ReeBill


Dependencies necessary for ReeBill 
==================================

Specific, current documentation is found in the Billing/docs/ Directory

Ensure a user and virtualenv have been set up if desired.
Ensure that an apache virtual host has been set up.
Ensure that the /db utility bill directory exists as specified in the reebill.cfg file
Ensure that Mongo is available
Ensure that MySQL Server is available


This dependency has to be included to make the v1 to v2 convert script work
        ordereddict (backport of ordereddict to r2.x)

Realize that pip and easy_install may need to have the virtualenv specified.
    pip install -E
    NB: if using a version of pip higher than 1.0, -E has been deprecated in favor of -t; for example, `pip install -E /path/to/virtualenv package` has become `pip install -t /path/to/virtualenv/lib/pythonX.X/site-packages/ package`


Install ExtJS: Deprecated - Ext is in the reebill/ui directory and is automatically deployed

    http://www.sencha.com/products/extjs/download/ext-js-3.3.1/186
    Extract into the root web directory so that the Ext Framework can be served


Install ChartDirector:

    http://www.advsofteng.com/download.html
    http://download2.advsofteng.com/chartdir_python_linux.tar.gz
    http://download2.advsofteng.com/chartdir_python_linux_64.tar.gz

    The files for the ChartDirector for Python module are in "ChartDirector/lib". Copy *everything* in "ChartDirector/lib" (including the fonts subdirectory in Linux, FreeBSD and Solaris versions) to a directory in your Python module search path.  This path may have to be set in the WSGI configuration if used by a WSGI app.
    There is no setup.py, so manually copy to site or dist-packages (may be site-packages under windows)
        For example, 
            mkdir /var/local/reebill-[env]/lib/python2.6/site-packages/ChartDirector
            mkdir /var/local/reebill-[env]/lib/python2.6/site-packages/ChartDirector/lib
            cp ChartDirector/lib/* /var/local/reebill-[env]/lib/python2.6/site-packages/ChartDirector/lib
    (ToDo: figure out if there is anything wrong with manually copying to dist-packages as well as how to get python to find it without having to set the path manually)
    PYTHONPATH must point to .../ChartDirector/lib or the location to where it was copied
    This is accomplished by adding python path to WSGIDaemonProcess directive in Apache2 .../ChartDirector/lib
    For example:
        WSGIDaemonProcess reebill-prod user=reebill-prod group=reebill-prod processes=1 threads=10 python-path=/var/local/reebill-prod/lib/python2.7/site-packages/ChartDirector/lib/:/var/local/reebill-prod/lib/python2.7/site-packages

    Ensure ReeBill fonts are included for Chart Director:
        Manually add third party fonts to the ChartDirector font directory /usr/lib/python2.6/dist-packages/ChartDirector/lib/fonts
        For example, sudo cp billing/presentation/fonts/* /usr/lib/python2.6/dist-packages/ChartDirector/lib/fonts/
        For example, as the application user: cp /var/local/reebill-stage/lib/python2.6/site-packages/billing/reebill/fonts/* /var/local/reebill-stage/lib/python2.6/site-packages/ChartDirector/lib/fonts/



see dedicated-installation.txt for details on configurations below



Install Mongo driver:

    enable virtualenv
    pip install pymongo

Install SQLAlchemy:

    enable virtualenv
    pip install sqlalchemy

Install ReportLab 2.5: deprecated (see dedicated install)

    easy install is used, but the virtualenv has to be specified:

     export PYTHONPATH=/var/local/reebill-[env name]/lib/python2.6/site-packages
     easy_install -d /var/local/reebill-[env name]/lib/python2.6/site-packages reportlab

     See easy_install --help

    Old Method:
        http://www.reportlab.com/software/downloads/
        wget http://www.reportlab.com/ftp/reportlab-2.5.tar.gz
        Install: sudo python setup.py install
        Ensure that the correct fonts are available:
        sudo cp -r ReportLab_2_4/src/reportlab/fonts/ /usr/lib/python2.6/dist-packages/reportlab/

    Investigate:
    # installing without freetype no ttf, sorry!
    # You need to install a static library version of the freetype2 software
    # If you need truetype support in renderPM
    # You may need to edit setup.cfg (win32)
    # or edit this file to access the library if it is installed

Install PIL:

    enable virtualenv
    pip install pil

    pil needs to be installed for <img> markup to work in RL.  "'NoneType' object has no attribute 'Image'" is the clear error message...

Install xlwt:

    pip install xlwt

Install dependencies for bill image rendering (global across virtualenv's!):
    sudo apt-get install imagemagick
    sudo apt-get install html2ps
    sudo apt-get install poppler-utils (for pdftoppm)



Generic AWS Hosting Configuration Instructions for ReeBill
==========================================================

How to create a dedicated host running once instance of ReeBill

DNS 
---

[customer].skylineinnovations.net must point to an AWS dynamic name or an Elastic IP



SSL
---

SSL Certificates are not configured at this time


AWS Host Setup
--------------

Create reebill hosting security group admitting SSH and HTTP/S

32 bit Amazon Linux AMI ami-31814f58, Small instance


SSH Keys are saved in IT/ec2keys

Connecting to the newly configured host:   
ssh -i /home/randrews/Dropbox/Skyline-IT/ec2keys/reebill-atsite.pem ec2-user@ec2-50-16-73-74.compute-1.amazonaws.com


Create user for running and deploying ReeBill

    sudo useradd -s /bin/bash --create-home reebill

    sudo passwd reebill [passwd] 
    set passwd, storing it in keepass (necessary? do we ever log-in as the application user?)


Install Packages
================

The AWS Linux AMI is based on Fedora and uses yum.

Update the host
    sudo yum update
Obtain pip
    activate virtualenv
    sudo easy_install pip
Install gcc and python heads so packages like pymongo and numpy can compile C extensions
    sudo yum install python-devel gcc

Install the following packages with sudo pip install [package]
    cherrypy
    jinja2
    pymongo==2.2.1
    fabulous (unused?)
    code (pip could not find it)
    sqlalchemy
    py-bcrypt
    argparse
    numpy
    reportlab
    simplejson
    MySQL-Python
    xlwt
    pyyaml (unused?)
    ordereddict (for 2.6 installs only)
    mongoengine
    pypdf
    requests
    gevent

For Rendering Images
    sudo yum install ImageMagick
    sudo yum install html2ps
    sudo yum install poppler-utils (for pdftoppm)
    

Chart Director 'pychartdir'
    Chart Director is installed by:
        tar xvf chartdir_python_linux.tar
        mv ChartDirector /usr/lib/python2.6/site-packages
        Then add python path to WSGIDaemonProcess directive in Apache2 /usr/lib/python2.6/site-packages/ChartDirector/lib
    Fonts have to be copied?


MySQL


    If pip install MySQL-Python fails with the following error, mysql_config is not available.
    Install it by: sudo apt-get install libmysqlclient-dev

            $ pip install MySQL-Python
            Downloading/unpacking MySQL-Python
              Downloading MySQL-python-1.2.3.tar.gz (70Kb): 70Kb downloaded
              Running setup.py egg_info for package MySQL-Python
                sh: mysql_config: not found
                Traceback (most recent call last):
                  File "<string>", line 14, in <module>
                  File "/home/randrews/.virtualenvs/reebill/build/MySQL-Python/setup.py", line 15, in <module>
                    metadata, options = get_config()
                  File "setup_posix.py", line 43, in get_config
                    libs = mysql_config("libs_r")
                  File "setup_posix.py", line 24, in mysql_config
                    raise EnvironmentError("%s not found" % (mysql_config.path,))
                EnvironmentError: mysql_config not found
                Complete output from command python setup.py egg_info:
                sh: mysql_config: not found

            Traceback (most recent call last):

              File "<string>", line 14, in <module>

              File "/home/randrews/.virtualenvs/reebill/build/MySQL-Python/setup.py", line 15, in <module>

                metadata, options = get_config()

              File "setup_posix.py", line 43, in get_config

                libs = mysql_config("libs_r")

              File "setup_posix.py", line 24, in mysql_config

                raise EnvironmentError("%s not found" % (mysql_config.path,))

            EnvironmentError: mysql_config not found

            ----------------------------------------
            Command python setup.py egg_info failed with error code 1 in /home/randrews/.virtualenvs/reebill/build/MySQL-Python
            Storing complete log in /home/randrews/.pip/pip.log

    Configure MySQL Database for bill processing 

        Set up a local instance of MySQL-Server and configure local accounts following host-setup.txt

        So that an administrative user can run connect remotely - do this only for dev/stage
        grant all on skyline.* to 'root'@'%.local' identified by '[password]';


        Log in as database root user
        mysql -uroot -p


        create database skyline_[env]
        use skyline_[env]


        create user 'reebill-[env]'@'%' identified by '[password]'
        (does this mean reebill-prod can connect from any host?
        grant all on skyline_[env].* to 'reebill-[env]'@'%' identified by '[password]';

        This worked on linux AMI version of MySQL
        create user 'reebill-[env]'@'localhost' identified by '[password]'
        grant all on skyline_[env].* to 'reebill-[env]'@'localhost' identified by '[password]';

        Loading the database:

        mysql -ureebill-[env] -p[password] -Dskyline-[env] < [workspace]/billing/db/processing/billdb.sql
        - or -
        restore from backup (must  be done as root for some reason)
        mysql --verbose -uroot -p -Dskyline-[env] < ~/[date]billing_mysql.dmp

        scp -i ~/Dropbox/Skyline-IT/ec2keys/tyrell-prod.pem /tmp/20120704reebill-prod.tar.z ec2-user@tyrell-prod.skylineinnovations.net:/tmp

        For Development:

        Install MySQL WorkBench
            http://dev.mysql.com/downloads/workbench/5.2.html (deb available)
            http://www.mysql.com/downloads/workbench/#downloads

        How to create a development database
            create user 'dev'@'10.0.0.%' identified by 'dev'
            create database skyline_stage
            grant all on skyline_dev.* to 'dev'@'10.0.0.%' identified by 'dev';
            mysql --verbose -uroot -p -D skyline_dev < ~/20110606billing_mysql.dmp

        See /docs/host-setup.txt for details on installing MySQL

        grant all on skyline.* to 'root'@'%.local' identified by '[password]';

        create database skyline_[env]
        use skyline_[env]

        create user 'reebill'@'%' identified by '[password]'
        # needs to be done to allow connections from localhost
        create user 'reebill'@'localhost' identified by '[password]';
        # for connecting from anywhere
        #grant all on skyline.* to 'reebill'@'%' identified by '[password]';
        # for connecting from localhost
        grant all on skyline.* to 'reebill'@'localhost' identified by '[password]';



        Loading the database
        --------------------

            # root has to create the schema because full privileged users do not have all the privileges to do so
            mysql -uroot -p[password] -Dskyline < /var/local/reebill/billing/db/processing/billdb.sql






Configure Apache2 
=================

    Predicates
    ----------

    Installed Apache2
    Installed and enabled mod_wsgi for Python WSGI applications
    Created user that will run the WSGI code
        sudo mkdir /var/local/reebill
        sudo chown -R reebill:reebill /var/local/reebill

    Deployed software in the WSGI code directory


    Big catch on AWS Linux AMI:  
        http://code.google.com/p/modwsgi/wiki/ConfigurationIssues
        Add this to the wsgi module config file
        WSGISocketPrefix /var/run/wsgi
    

    Virtual Hosting
    ---------------

    Configure a name based virtual host for your development environment
        Ensure that the Apache2 host knows of the virtual hostnames so Apache can start virtual hosts with ServerName directive

        Add to /etc/hosts:
            [local ip address] atsite

        Ensure that NameVirtualHost *:80 is declared in an appropriate httpd configuration file

        Declare the virtual host's name in the site configuration file
            ServerName [virtualhostname]

        Restart Apache2
            sudo service httpd restart

    Example virtual host config directive
    -------------------------------------
<VirtualHost *:80>
        ServerName reebill-prod
        ServerAlias reebill
        serverAlias reebill.skylineinnovations.net
        serverAlias reebill-prod.skylineinnovations.net

        ServerAdmin webmaster@localhost

        DocumentRoot /var/local/reebill-prod/lib/python2.7/site-packages/billing/reebill/ui
        <Directory /var/local/reebill-prod/lib/python2.7/site-packages/billing/reebill/ui>
                DirectoryIndex /reebill 
                Options FollowSymLinks
                AllowOverride None
        </Directory>
        # directory where utility bill images are saved
        Alias /utilitybillimages /tmp/billimages-prod
        <Directory /tmp/billimages>
            #Order deny,allow
            #Allow from all
            Options Indexes FollowSymLinks MultiViews
            #AllowOverride None
        </Directory>


        ErrorLog /var/log/httpd/reebill-prod_error.log

        # Possible values include: debug, info, notice, warn, error, crit,
        # alert, emerg.
        LogLevel debug

        CustomLog /var/log/httpd/reebill-prod_access.log combined

        WSGIScriptAlias /reebill /var/local/reebill-prod/lib/python2.7/site-packages/billing/reebill/bill_tool_bridge.py

        WSGIDaemonProcess reebill-prod user=reebill-prod group=reebill-prod processes=1 threads=1 python-path=/var/local/reebill-prod/lib/python2.7/site-packages/ChartDirector/lib/:/var/local/reebill-prod/lib/python2.7/site-packages
        WSGIApplicationGroup %{GLOBAL}

        WSGIProcessGroup reebill-prod

</VirtualHost>




    Deploy software
    ---------------

    fab deploy -R atsite
    




Creating Initial User
=====================

    [ec2-user@domU-12-31-39-07-5C-C2 billing]$ mongo
    MongoDB shell version: 2.0.2
    connecting to: test
    > use skyline
    switched to db skyline
    > db.users.find()
    > db.users.save({ "_id" : "atsite", "username" : "atsite", "preferences" : { "bill_image_resolution" : 90 } })


Ensure Ext plug-ins are properly installed
==========================================

fabexcludes no longer excludes them
    GET http://atsite.skylineinnovations.net/ext-3.3.1/examples/ux/css/Spinner.css 404 (Not Found)
    GET http://atsite.skylineinnovations.net/ext-3.3.1/examples/ux/Spinner.js 404 (Not Found)
    GET http://atsite.skylineinnovations.net/ext-3.3.1/examples/ux/SpinnerField.js 404 (Not Found)
    GET http://atsite.skylineinnovations.net/ext-3.3.1/examples/ux/GroupSummary.js 404 (Not Found)



MISC
====

The WSGI user must own the /db directory


CRON
====

Necessary cron jobs for running ReeBill

The python path for cron jobs should be .:/var/local/reebill-stage/lib/python2.6/site-packages/ChartDirector/lib/

python/var/local/reebill-prod/lib/python2.6/site-packages/billing/reconciliation.py --statedb skyline_prod --stateuser prod --statepw AXUPU4XGMSN --billdb skyline-prod



SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
PYTHONPATH=/var/local/reebill-stage/lib/python2.6/site-packages:/var/local/reebill-stage/lib/python2.6/site-packages/ChartDirector/lib

for staging env:

# m h  dom mon dow   command
0 2 * * * /var/local/reebill-stage/lib/python2.6/site-packages/billing/reebill/admin/destage.bash
0 3 * * * /var/local/reebill-stage/lib/python2.6/site-packages/billing/reconciliation.py --statedb skyline_stage  --stateuser stage --statepw stage --billdb skyline-stage --olapdb dev --skip-oltp



For a production environment
----------------------------

It is important to note that backup_prod.bash creates a file in /tmp that is used by destage_from_prod.bash

SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
PYTHONPATH=/var/local/reebill-prod/lib/python2.7/site-packages:/var/local/reebill-prod/lib/python2.7/site-packages/ChartDirector/lib
MAILTO=randrews@skylineinnovations.com

# m h  dom mon dow   command
0 6 * * * /var/local/reebill-prod/lib/python2.7/site-packages/billing/reebill/admin/backup_prod.bash
0 7 * * * source /var/local/reebill-prod/bin/activate && /var/local/reebill-prod/lib/python2.7/site-packages/billing/reconciliation.py --host localhost --statedb skyline_prod  --stateuser root --statepw P4IMvFI9DRTd --billdb skyline-prod --olapdb prod --skip-oltp --nexushost nexus.skylineinnovations.net
